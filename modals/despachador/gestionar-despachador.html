<!-- MODAL GESTIONAR SOLICITUD - DESPACHADOR -->
<div class="modal fade" id="modalGestionarSolicitudDesp" tabindex="-1" role="dialog" aria-labelledby="modalGestionarSolicitudDespLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGestionarSolicitudDespLabel">
                    <i class="fas fa-tasks mr-2"></i>Gestionar Solicitud - Despachador
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Leyenda de campos obligatorios -->
                <div class="alert alert-info mb-3" role="alert">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Leyenda:</strong>
                    <span class="ml-3"><span class="text-danger">*</span> Campos obligatorios</span>
                    <span class="ml-3"><span class="badge badge-warning">EDITABLE</span> Campos que pueden modificarse</span>
                </div>
                
                <!-- Header: Estado y Observaciones -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado y Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert mb-0 d-flex align-items-center" role="alert" id="gestionarDespEstadoAlert">
                                    <i class="fas fa-circle mr-2"></i>
                                    <div>
                                        <strong>Estado:</strong> <span class="badge ml-2" id="gestionarDespEstadoBadge">-</span>
                                        <small class="d-block mt-1 text-muted" id="gestionarDespEstadoDescripcion">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1"><strong>Observaciones:</strong></label>
                                    <p class="mb-0" id="gestionarDespObservacionesHeader">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Identificación (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-edit mr-2"></i>Identificación <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">ID Solicitud <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="gestionarDespIDSolicitud" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespTipo" required>
                                        <option value="">Seleccione...</option>
                                        <option value="SDCN">SDCN - Solicitud de Desconexión Curso Normal</option>
                                        <option value="SDCF">SDCF - Solicitud de Desconexión Curso Forzoso</option>
                                        <option value="SICN">SICN - Solicitud de Intervención Curso Normal</option>
                                        <option value="SICF">SICF - Solicitud de Intervención Curso Forzoso</option>
                                        <option value="IL">IL - Informe de Línea</option>
                                        <option value="MM">MM - Mantención Mayor</option>
                                        <option value="SODI">SODI - Solicitud de Desconexión/Intervención</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Relación SODI/CEN</label>
                                    <textarea class="form-control" id="gestionarDespRelacionSODICEN" rows="2" placeholder="Ej: CEN-2025-001, SODI-123"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Programadas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Programado</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespInicioProgramado">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Programado</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespFinProgramado">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Efectivas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="far fa-calendar-check mr-2"></i>Fechas Efectivas de Ejecución <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Efectivo</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespInicioEfectivo">
                                    <small class="form-text text-muted">Al completar, cambia a "Vigente"</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Efectivo</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespFinEfectivo">
                                    <small class="form-text text-muted">Al completar, cambia a "Finalizada"</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Empresas Involucradas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-edit mr-2"></i>Empresas Involucradas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Empresa Solicitante <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespEmpresaSolicitante" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Empresa Receptora <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespEmpresaReceptora" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Instalación y Equipos -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-building mr-2"></i>Instalación y Equipos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Instalación GM</label>
                                    <select class="form-control" id="gestionarDespInstalacionGM" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Santiago Solar">Santiago Solar</option>
                                        <option value="Nueva Renca">Nueva Renca</option>
                                        <option value="Los Vientos">Los Vientos</option>
                                        <option value="Santa Lidia">Santa Lidia</option>
                                        <option value="CEME1">CEME1</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Instalaciones/equipos a intervenir</label>
                                    <input type="text" class="form-control" id="gestionarDespEquipos" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Características de la Intervención (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Características de la Intervención</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Intervención</label>
                                    <select class="form-control" id="gestionarDespTipoIntervencion" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Intervención">Intervención</option>
                                        <option value="Desconexión">Desconexión</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Potencia (MWH)</label>
                                    <input type="text" class="form-control" id="gestionarDespPotencia" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Aplica SODI</label>
                                    <select class="form-control" id="gestionarDespAplicaSODI" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Clasificación del Riesgo</label>
                                    <select class="form-control" id="gestionarDespRiesgo" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Bajo">Bajo</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Alto">Alto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2" id="gestionarDespDescripcionRiesgoContainer" style="display: none;">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción del Riesgo</label>
                                    <textarea class="form-control" id="gestionarDespDescripcionRiesgo" rows="2" readonly></textarea>
                                    <small class="form-text text-muted">Se muestra solo si el riesgo es Medio o Alto</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Descripción y Condiciones (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Descripción del trabajo</label>
                                    <textarea class="form-control" id="gestionarDespDescripcion" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Condiciones requeridas</label>
                                    <textarea class="form-control" id="gestionarDespCondiciones" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Comentarios</label>
                                    <textarea class="form-control" id="gestionarDespComentariosActuales" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Afectaciones</label>
                                    <select class="form-control" id="gestionarDespAfectaciones" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="SSCC">SSCC</option>
                                        <option value="Protecciones">Protecciones</option>
                                        <option value="Medidores">Medidores</option>
                                        <option value="SSCC, Protecciones">SSCC, Protecciones</option>
                                        <option value="SSCC, Medidores">SSCC, Medidores</option>
                                        <option value="Protecciones, Medidores">Protecciones, Medidores</option>
                                        <option value="SSCC, Protecciones, Medidores">SSCC, Protecciones, Medidores</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6" id="gestionarDespDescripcionAfectacionContainer" style="display: none;">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción de la Afectación</label>
                                    <textarea class="form-control" id="gestionarDespDescripcionAfectacion" rows="2" readonly></textarea>
                                    <small class="form-text text-muted">Se muestra solo si hay afectaciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Archivo Adjunto (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivo Adjunto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <span id="gestionarDespAdjunto" class="text-muted">-</span>
                                    <button type="button" class="btn btn-sm btn-primary ml-2" id="gestionarDespDescargarAdjunto" style="display:none;">
                                        <i class="fas fa-download mr-1"></i>Descargar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Gestión -->
                <div class="card mb-3 border-success">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-tasks mr-2"></i>Gestión de la Solicitud</h6>
                    </div>
                    <div class="card-body">
                        <!-- Observaciones actuales -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info" role="alert">
                                    <strong><i class="fas fa-info-circle mr-2"></i>Observaciones Actuales:</strong>
                                    <p class="mb-0 mt-2" id="gestionarDespObservacionesActuales">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Nuevas observaciones -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="font-weight-bold">Nuevas Observaciones <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="gestionarDespComentarios" rows="3" placeholder="Ingrese las observaciones sobre la gestión..." required></textarea>
                                    <small class="form-text text-muted"><i class="fas fa-exclamation-circle mr-1"></i>Estas observaciones se agregarán al historial</small>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones disponibles según el estado -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Acción a realizar <span class="text-danger">*</span></label>
                                    <div id="gestionarDespAccionesContainer">
                                        <!-- Las acciones se cargarán dinámicamente según el estado -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata del Sistema -->
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-info-circle mr-2"></i>Información del Sistema
                        </h6>
                    </div>
                </div>
                <div class="row bg-light p-3 rounded">
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>ID</strong></label>
                            <p class="mb-0" id="gestionarDespIDRegistro">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Creado</strong></label>
                            <p class="mb-0" id="gestionarDespCreado">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Actualizado</strong></label>
                            <p class="mb-0" id="gestionarDespActualizado">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Administrador</strong></label>
                            <p class="mb-0" id="gestionarDespAdministrador">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Solicitante</strong></label>
                            <p class="mb-0" id="gestionarDespSolicitante">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Creado Por</strong></label>
                            <p class="mb-0" id="gestionarDespCreadoPor">-</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarGestionSolicitudDespachador()">
                    <i class="fas fa-check mr-2"></i>Confirmar Gestión
                </button>
            </div>
        </div>
    </div>
</div>
