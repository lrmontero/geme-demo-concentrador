<h2 class="mb-4"><i class="fas fa-clipboard-list"></i> Despachador - Control de Solicitudes</h2>

<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group mt-1" id="zona-botonera-filtro" role="group" aria-label="Botonera">
            <button id="showHideFilter" class="btn btn-secondary collapsed" type="button" data-toggle="collapse" data-target="#zona-filtro" aria-expanded="false" aria-controls="zona-filtro">
                <i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i>
                Mostrar filtro
            </button>
            <button id="clearFilter" class="btn btn-outline-dark" type="button" onclick="limpiarFiltros()">
                <i class="fas fa-broom mr-2" aria-hidden="true"></i>
                <span>Limpiar filtro</span>
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card collapse" id="zona-filtro">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de B√∫squeda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>ID Solicitud</label>
                            <input type="text" class="form-control" id="filtroIDSolicitudDesp" placeholder="Buscar por ID...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tipo</label>
                            <select class="form-control" id="filtroTipoDesp">
                                <option value="">Todos</option>
                                <option value="SDCN">SDCN - Solicitud de Desconexi√≥n Curso Normal</option>
                                <option value="SDCF">SDCF - Solicitud de Desconexi√≥n Curso Forzoso</option>
                                <option value="SICN">SICN - Solicitud de Intervenci√≥n Curso Normal</option>
                                <option value="SICF">SICF - Solicitud de Intervenci√≥n Curso Forzoso</option>
                                <option value="IL">IL - Informe de Limitaci√≥n</option>
                                <option value="MM">MM - Mantenci√≥n Mayor</option>
                                <option value="SODI">SODI - Solicitud de Desconexi√≥n/Intervenci√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaci√≥n GM</label>
                            <select class="form-control" id="filtroInstalacionGMDesp">
                                <option value="">Todas</option>
                                <option value="Santiago Solar">Santiago Solar</option>
                                <option value="Nueva Renca">Nueva Renca</option>
                                <option value="Los Vientos">Los Vientos</option>
                                <option value="Santa Lidia">Santa Lidia</option>
                                <option value="CEME1">CEME1</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Empresa Solicitante</label>
                            <select class="form-control" id="filtroEmpresaSolicitanteDesp">
                                <option value="">Todas</option>
                                <option value="CDC">CDC</option>
                                <option value="GM">GM</option>
                                <option value="Transelec Norte">Transelec Norte</option>
                                <option value="Transelec Sur">Transelec Sur</option>
                                <option value="Chilquinta">Chilquinta</option>
                                <option value="Saesa">Saesa</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Empresa Receptora</label>
                            <select class="form-control" id="filtroEmpresaReceptoraDesp">
                                <option value="">Todas</option>
                                <option value="CDC">CDC</option>
                                <option value="GM">GM</option>
                                <option value="Transelec Norte">Transelec Norte</option>
                                <option value="Transelec Sur">Transelec Sur</option>
                                <option value="Chilquinta">Chilquinta</option>
                                <option value="Saesa">Saesa</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Aplica SODI</label>
                            <select class="form-control" id="filtroAplicaSODIDesp">
                                <option value="">Todos</option>
                                <option value="S√≠">S√≠</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Desde</label>
                            <input type="date" class="form-control" id="filtroFechaDesdeDesp">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Hasta</label>
                            <input type="date" class="form-control" id="filtroFechaHastaDesp">
                        </div>
                    </div>
                </div>
                <div class="btns-accion-filtro">
                    <a href="javascript:;" class="btn-filtrar text-decoration-none" onclick="aplicarFiltrosDesp()">
                        <i class="fas fa-filter"></i> Filtrar
                    </a>
                    <a href="javascript:;" class="btn-limpiar text-decoration-none" onclick="limpiarFiltrosDesp()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 align-items-center">
    <div class="col-lg-6">
        <div class="botonera">
            <a class="btn btn-customized" href="javascript:;" role="button" onclick="abrirModalNuevaSolicitudDesp()" id="btn-newDoc">
                <i class="fa fa-plus"></i> Nueva Solicitud
            </a>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-12">
        <div class="row justify-content-end">
            <div class="form-group col-lg-4 col-md-4 col-sm-4 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" checked="" id="cbxEnProceso" autocomplete="off" onchange="filtrarPorEstado('proceso')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="En Proceso" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-4 col-md-4 col-sm-4 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxFinalizadas" autocomplete="off" onchange="filtrarPorEstado('finalizadas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Finalizadas" autocomplete="off">
                </div>
            </div>				
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="table-solicitudes" class="table table-sm table-hover table-bordered w-100">
                        <thead>
                            <tr class="table-group">
                                <th class="text-center">Acciones</th>
                                <th>ID Registro</th>
                                <th>ID Solicitud</th>
                                <th>Tipo</th>
                                <th>Fecha Prog. Inicio</th>
                                <th>Fecha Prog. Fin</th>
                                <th>Instalaci√≥n GM</th>
                                <th>Administrador</th>
                                <th>Solicitante</th>
                                <th>Empresa Solicitante</th>
                                <th>Empresa Receptora</th>
                                <th>Aplica SODI</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Cambiar texto del bot√≥n al colapsar/expandir
$('#zona-filtro').on('show.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Ocultar filtro');
});

$('#zona-filtro').on('hide.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Mostrar filtro');
});

// ============================================
// CARGAR DATOS DIN√ÅMICAMENTE DESDE solicitudesData
// ============================================
(function() {
    console.log('üîÑ Cargando solicitudes del despachador...');
    
    // Verificar que solicitudesData existe
    if (typeof solicitudesData === 'undefined') {
        console.error('‚ùå solicitudesData no est√° definido');
        return;
    }
    
    // El despachador puede ver TODAS las solicitudes
    const solicitudes = solicitudesData;
    console.log(`üìä Encontradas ${solicitudes.length} solicitudes totales`);
    
    const tbody = $('#table-solicitudes tbody');
    tbody.empty(); // Limpiar tabla
    
    // Generar cada fila
    solicitudes.forEach(solicitud => {
        // Determinar funci√≥n de ver seg√∫n el estado
        // Usar funci√≥n unificada para ver solicitudes
        const funcionVer = `verSolicitudDesp(${solicitud.ID_REGISTRO})`;
        
        // Determinar badge de tipo
        let badgeTipo = 'badge-secondary';
        switch(solicitud.TIPO) {
            case 'SDCN': badgeTipo = 'badge-primary'; break;
            case 'SICF': badgeTipo = 'badge-success'; break;
            case 'SODI': badgeTipo = 'badge-danger'; break;
            case 'IL': badgeTipo = 'badge-warning'; break;
            case 'MM': badgeTipo = 'badge-info'; break;
            case 'SDCF': badgeTipo = 'badge-dark'; break;
            case 'SICN': badgeTipo = 'badge-secondary'; break;
        }
        
        // Determinar badge de estado
        let badgeEstado = 'badge-secondary';
        let claseFinalizad = '';
        switch(solicitud.ESTADO) {
            case 'Pendiente': badgeEstado = 'badge-warning'; break;
            case 'Devuelta': badgeEstado = 'badge-danger'; break;
            case 'En An√°lisis': badgeEstado = 'badge-info'; break;
            case 'Administrador Gestionando': badgeEstado = 'badge-warning text-dark'; break;
            case 'Despachador Gestionando': badgeEstado = 'badge-warning text-dark'; break;
            case 'Programada': badgeEstado = 'badge-success'; break;
            case 'Vigente': badgeEstado = 'badge-primary'; break;
            case 'Extendida': badgeEstado = 'badge-secondary'; break;
            case 'Finalizada': 
                badgeEstado = 'badge-secondary'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'Rechazada': 
                badgeEstado = 'badge-danger'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'Suspendida': 
                badgeEstado = 'badge-dark'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'No Solicitada': 
                badgeEstado = 'badge-secondary'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
        }
        
        // Acciones del despachador
        let accionEditar = '';
        let accionGestionar = '';
        
        // Bot√≥n Editar: SOLO para "Despachador Gestionando"
        if (solicitud.ESTADO === 'Despachador Gestionando') {
            accionEditar = `
                <a href="javascript:;" onclick="editarSolicitudDesp(${solicitud.ID_REGISTRO})" class="text-warning" title="Editar">
                    <i class="fas fa-edit"></i>
                </a>
            `;
        }
        
        // Mostrar bot√≥n "Gestionar" solo para estados que el despachador puede gestionar
        const estadosGestionables = ['Despachador Gestionando', 'Programada', 'Vigente', 'Extendida'];
        if (estadosGestionables.includes(solicitud.ESTADO)) {
            accionGestionar = `
                <a href="javascript:;" onclick="gestionarSolicitudDesp(${solicitud.ID_REGISTRO})" class="text-danger ml-2" title="Gestionar">
                    <i class="fas fa-arrow-circle-right"></i>
                </a>
            `;
        }
        
        const acciones = `
            ${accionEditar}
            <a href="javascript:;" onclick="${funcionVer}" class="text-primary ml-2" title="Ver">
                <i class="fas fa-eye"></i>
            </a>
            <a href="javascript:;" onclick="clonarSolicitudDesp(${solicitud.ID_REGISTRO})" class="text-info ml-2" title="Clonar">
                <i class="fas fa-copy"></i>
            </a>
            ${accionGestionar}
            <a href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})" class="text-success ml-2" title="Bit√°cora">
                <i class="fas fa-clipboard-list"></i>
            </a>
        `;
        
        // Generar HTML de la fila
        const fila = `
            <tr class="${claseFinalizad}">
                <td class="text-center">${acciones}</td>
                <td>${solicitud.ID_REGISTRO}</td>
                <td>${solicitud.ID_SOLICITUD}</td>
                <td><span class="badge ${badgeTipo}">${solicitud.TIPO}</span></td>
                <td>${solicitud.INICIO_PROGRAMADO}</td>
                <td>${solicitud.FIN_PROGRAMADO}</td>
                <td>${solicitud.INSTALACION_GM}</td>
                <td>${solicitud.ADMINISTRADOR}</td>
                <td>${solicitud.SOLICITANTE}</td>
                <td>${solicitud.EMPRESA_SOLICITANTE}</td>
                <td>${solicitud.EMPRESA_RECEPTORA}</td>
                <td>${solicitud.APLICA_SODI}</td>
                <td><span class="badge ${badgeEstado}">${solicitud.ESTADO}</span></td>
            </tr>
        `;
        
        tbody.append(fila);
    });
    
    console.log('‚úÖ Solicitudes cargadas exitosamente');
})();

// Encapsular TODO en una IIFE para evitar conflictos de variables
(function() {
    // Variable local para el filtro actual
    let filtroActual = 'proceso';
    
    // Funci√≥n para limpiar filtros (legacy)
    window.limpiarFiltros = function() {
        $('#zona-filtro select').val('');
        $('#zona-filtro input').val('');
    };
    
    // Funci√≥n para aplicar filtros personalizados
    window.aplicarFiltrosDesp = function() {
        const table = $('#table-solicitudes').DataTable();
        
        // Obtener valores de filtros
        const filtroID = $('#filtroIDSolicitudDesp').val().toLowerCase();
        const filtroTipo = $('#filtroTipoDesp').val();
        const filtroInstalacion = $('#filtroInstalacionGMDesp').val();
        const filtroEmpSol = $('#filtroEmpresaSolicitanteDesp').val();
        const filtroEmpRec = $('#filtroEmpresaReceptoraDesp').val();
        const filtroSODI = $('#filtroAplicaSODIDesp').val();
        const filtroFechaDesde = $('#filtroFechaDesdeDesp').val();
        const filtroFechaHasta = $('#filtroFechaHastaDesp').val();
        
        // Aplicar b√∫squeda por ID
        table.column(2).search(filtroID);
        
        // Aplicar b√∫squeda por Tipo
        table.column(3).search(filtroTipo);
        
        // Aplicar b√∫squeda por Instalaci√≥n GM
        table.column(6).search(filtroInstalacion);
        
        // Aplicar b√∫squeda por Empresa Solicitante
        table.column(9).search(filtroEmpSol);
        
        // Aplicar b√∫squeda por Empresa Receptora
        table.column(10).search(filtroEmpRec);
        
        // Aplicar b√∫squeda por Aplica SODI
        table.column(11).search(filtroSODI);
        
        // Redibujar tabla
        table.draw();
        
        console.log('Filtros aplicados:', {filtroID, filtroTipo, filtroInstalacion, filtroEmpSol, filtroEmpRec, filtroSODI});
    };
    
    // Funci√≥n para limpiar filtros personalizados
    window.limpiarFiltrosDesp = function() {
        // Limpiar inputs
        $('#filtroIDSolicitudDesp').val('');
        $('#filtroTipoDesp').val('');
        $('#filtroInstalacionGMDesp').val('');
        $('#filtroEmpresaSolicitanteDesp').val('');
        $('#filtroEmpresaReceptoraDesp').val('');
        $('#filtroAplicaSODIDesp').val('');
        $('#filtroFechaDesdeDesp').val('');
        $('#filtroFechaHastaDesp').val('');
        
        // Limpiar b√∫squedas de DataTable
        const table = $('#table-solicitudes').DataTable();
        table.search('').columns().search('').draw();
        
        console.log('Filtros limpiados');
    };
    
    // Funci√≥n para filtrar por estado
    window.filtrarPorEstado = function(tipo) {
        console.log('Filtrando por:', tipo);
        filtroActual = tipo;
        
        const table = $('#table-solicitudes').DataTable();
        
        // Aplicar el filtro y redibujar
        table.draw();
    };
    
    // Destruir DataTable si ya existe
    if ($.fn.DataTable.isDataTable('#table-solicitudes')) {
        $('#table-solicitudes').DataTable().destroy();
    }
    
    // Limpiar filtros personalizados anteriores
    $.fn.dataTable.ext.search = [];
    
    // Remover el display:none inline de las filas finalizadas para que DataTables las pueda procesar
    $('.solicitud-finalizada').removeAttr('style');
    
    // Estados que se consideran "En Proceso" para Despachador
    const estadosEnProceso = ['Despachador Gestionando', 'Programada', 'Vigente', 'Extendida'];
    
    // Estados que se consideran "Finalizadas"
    const estadosFinalizadas = ['Finalizada', 'No Solicitada', 'Rechazada', 'Suspendida'];
    
    // Funci√≥n de filtro personalizada
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // data[12] es la columna del Estado (√≠ndice 12, la √∫ltima columna)
            const estadoColumna = data[12]; // Contiene el HTML del badge
            
            // Extraer el texto del estado del HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = estadoColumna;
            const estado = tempDiv.textContent.trim();
            
            if (filtroActual === 'proceso') {
                // Mostrar solo estados en proceso (Programada, Vigente, Extendida)
                return estadosEnProceso.includes(estado);
            } else if (filtroActual === 'finalizadas') {
                // Mostrar solo estados finalizadas
                return estadosFinalizadas.includes(estado);
            }
            return true;
        }
    );
    
    $('#table-solicitudes').DataTable({
        "language": {
            "lengthMenu": "Mostrando _MENU_ solicitudes por p√°gina",
            "zeroRecords": "No se encontraron resultados",
            "info": "Total solicitudes: _TOTAL_. Mostrando p√°gina _PAGE_ de _PAGES_",
            "infoEmpty": "No hay solicitudes disponibles",
            "infoFiltered": "(filtrado de _MAX_ solicitudes totales)",
            "search": "Buscar",
            "paginate": {
                "first": "Primero",
                "last": "√öltimo",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Mostrar todo"]],
        "responsive": true,
        "order": [[1, "desc"]],
        "columnDefs": [
            { "orderable": false, "targets": 0 }
        ]
    });
})();
</script>

<!-- Cargar modales del despachador -->
<script src="modals/despachador/modals-loader.js?v=2" defer></script>
