<h2 class="mb-4"><i class="fas fa-file-alt"></i> Solicitudes</h2>

<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group mt-1" id="zona-botonera-filtro" role="group" aria-label="Botonera">
            <button id="showHideFilter" class="btn btn-secondary collapsed" type="button" data-toggle="collapse" data-target="#zona-filtro" aria-expanded="false" aria-controls="zona-filtro">
                <i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i>
                Mostrar filtro
            </button>
            <button id="clearFilter" class="btn btn-outline-dark" type="button" onclick="limpiarFiltros()">
                <i class="fas fa-broom mr-2" aria-hidden="true"></i>
                <span>Limpiar filtro</span>
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card collapse" id="zona-filtro">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de B√∫squeda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaci√≥n GM</label>
                            <select class="form-control" id="filtroInstalacionGMSolic">
                                <option value="">Todas</option>
                                <option value="Santiago Solar">Santiago Solar</option>
                                <option value="Nueva Renca">Nueva Renca</option>
                                <option value="Los Vientos">Los Vientos</option>
                                <option value="Santa Lidia">Santa Lidia</option>
                                <option value="CEME1">CEME1</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaciones/Equipos a intervenir</label>
                            <input type="text" class="form-control" id="filtroEquiposSolic" placeholder="Buscar equipos...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tipo Intervenci√≥n</label>
                            <select class="form-control" id="filtroTipoIntervencionSolic">
                                <option value="">Todos</option>
                                <option value="Intervenci√≥n">Intervenci√≥n</option>
                                <option value="Desconexi√≥n">Desconexi√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Riesgo</label>
                            <select class="form-control" id="filtroRiesgoSolic">
                                <option value="">Todos</option>
                                <option value="Bajo">Bajo</option>
                                <option value="Medio">Medio</option>
                                <option value="Alto">Alto</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Aplica SODI</label>
                            <select class="form-control" id="filtroAplicaSODISolic">
                                <option value="">Todos</option>
                                <option value="S√≠">S√≠</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Desde</label>
                            <input type="date" class="form-control" id="filtroFechaDesdeSolic">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Hasta</label>
                            <input type="date" class="form-control" id="filtroFechaHastaSolic">
                        </div>
                    </div>
                </div>
                <div class="btns-accion-filtro">
                    <a href="javascript:;" class="btn-filtrar text-decoration-none" onclick="aplicarFiltrosSolic()">
                        <i class="fas fa-filter"></i> Filtrar
                    </a>
                    <a href="javascript:;" class="btn-limpiar text-decoration-none" onclick="limpiarFiltrosSolic()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 align-items-center">
    <div class="col-lg-6">
        <div class="botonera">
            <a class="btn btn-customized" href="javascript:;" role="button" onclick="abrirModalNuevaSolicitudSolic()" id="btn-newDoc">
                <i class="fa fa-plus"></i> Nueva Solicitud
            </a>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-12">
        <div class="row justify-content-end">
            <div class="form-group col-lg-4 col-md-4 col-sm-4 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" checked="" id="cbxEnProceso" autocomplete="off" onchange="filtrarPorEstado('proceso')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="En Proceso" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-4 col-md-4 col-sm-4 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxFinalizadas" autocomplete="off" onchange="filtrarPorEstado('finalizadas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Finalizadas" autocomplete="off">
                </div>
            </div>				
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaSolicitudesSolicitante" class="table table-sm table-hover table-bordered w-100">
                        <thead>
                            <tr class="table-group">
                                <th class="text-center">Acciones</th>
                                <th>ID Registro</th>
                                <th>Fecha Prog. Inicio</th>
                                <th>Fecha Prog. Fin</th>
                                <th>Instalaci√≥n GM</th>
                                <th>Instalaciones/Equipos a intervenir</th>
                                <th>Tipo Intervenci√≥n</th>
                                <th>Riesgo</th>
                                <th>Aplica SODI</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las filas se cargan din√°micamente desde data/solicitudes.js mediante js/solicitante.js -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cambiar texto del bot√≥n al colapsar/expandir
$('#zona-filtro').on('show.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Ocultar filtro');
});

$('#zona-filtro').on('hide.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Mostrar filtro');
});

// ============================================
// CARGAR DATOS DIN√ÅMICAMENTE DESDE solicitudesData
// ============================================
(function() {
    console.log('üîÑ Cargando solicitudes del solicitante...');
    
    // Verificar que solicitudesData existe
    if (typeof solicitudesData === 'undefined') {
        console.error('‚ùå solicitudesData no est√° definido');
        setTimeout(arguments.callee, 100); // Reintentar en 100ms
        return;
    }
    
    // Filtrar solo solicitudes creadas por solicitante
    const solicitudes = solicitudesData.filter(sol => sol.CREADO_POR === 'Solicitante');
    console.log(`üìä Encontradas ${solicitudes.length} solicitudes del solicitante`);
    
    const tbody = $('#tablaSolicitudesSolicitante tbody');
    tbody.empty(); // Limpiar tabla
    
    // Generar cada fila
    solicitudes.forEach(solicitud => {
        // Determinar funci√≥n de ver seg√∫n el estado
        // Usar funci√≥n unificada para ver solicitudes
        const funcionVer = `verSolicitudSolic(${solicitud.ID_REGISTRO})`;
        
        // Determinar badge de riesgo
        let badgeRiesgo = 'badge-secondary';
        switch(solicitud.RIESGO) {
            case 'Bajo': badgeRiesgo = 'badge-info'; break;
            case 'Medio': badgeRiesgo = 'badge-warning'; break;
            case 'Alto': badgeRiesgo = 'badge-danger'; break;
        }
        
        // Determinar badge de estado
        let badgeEstado = 'badge-secondary';
        switch(solicitud.ESTADO) {
            case 'Pendiente': badgeEstado = 'badge-warning'; break;
            case 'Devuelta': badgeEstado = 'badge-danger'; break;
            case 'En An√°lisis': badgeEstado = 'badge-info'; break;
            case 'Administrador Gestionando': badgeEstado = 'badge-warning text-dark'; break;
            case 'Programada': badgeEstado = 'badge-success'; break;
            case 'Vigente': badgeEstado = 'badge-primary'; break;
            case 'Extendida': badgeEstado = 'badge-secondary'; break;
            case 'Finalizada': badgeEstado = 'badge-dark'; break;
            case 'Rechazada': badgeEstado = 'badge-danger'; break;
        }
        
        // Determinar acciones seg√∫n el estado
        let acciones = '';
        if (['Devuelta'].includes(solicitud.ESTADO)) {
            // Estados editables para el solicitante (Devuelta)
            acciones = `

                <a href="javascript:;" onclick="abrirModalEditarSolic(${solicitud.ID_REGISTRO})" class="text-warning ml-2" title="Editar">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="javascript:;" onclick="${funcionVer}" class="text-primary ml-2" title="Ver">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="javascript:;" onclick="clonarSolicitudSolic(${solicitud.ID_REGISTRO})" class="text-info ml-2" title="Clonar">
                    <i class="fas fa-copy"></i>
                </a>
                <a href="javascript:;" onclick="gestionarSolicitudSolic(${solicitud.ID_REGISTRO})" class="text-danger ml-2" title="Gestionar">
                    <i class="fas fa-arrow-circle-right"></i>
                </a>
                <a href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})" class="text-success ml-2" title="Bit√°cora">
                    <i class="fas fa-clipboard-list"></i>
                </a>
            `;
        } else {
            // Estados no editables (solo ver, clonar y bit√°cora)
            acciones = `
                <a href="javascript:;" onclick="${funcionVer}" class="text-primary" title="Ver">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="javascript:;" onclick="clonarSolicitudSolic(${solicitud.ID_REGISTRO})" class="text-info ml-2" title="Clonar">
                    <i class="fas fa-copy"></i>
                </a>
                <a href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})" class="text-success ml-2" title="Bit√°cora">
                    <i class="fas fa-clipboard-list"></i>
                </a>
            `;
        }
        
        // Generar HTML de la fila
        const fila = `
            <tr>
                <td class="text-center">${acciones}</td>
                <td>${solicitud.ID_REGISTRO}</td>
                <td>${solicitud.INICIO_PROGRAMADO}</td>
                <td>${solicitud.FIN_PROGRAMADO}</td>
                <td>${solicitud.INSTALACION_GM}</td>
                <td>${solicitud.EQUIPOS}</td>
                <td>${solicitud.TIPO_INTERVENCION}</td>
                <td><span class="badge ${badgeRiesgo}">${solicitud.RIESGO}</span></td>
                <td>${solicitud.APLICA_SODI}</td>
                <td><span class="badge ${badgeEstado}">${solicitud.ESTADO}</span></td>
            </tr>
        `;
        
        tbody.append(fila);
    });
    
    console.log('‚úÖ Solicitudes cargadas exitosamente');
})();

// Encapsular TODO en una IIFE para evitar conflictos de variables
(function() {
    // Variable local para el filtro actual
    let filtroActual = 'proceso';
    
    // Funci√≥n para limpiar filtros (legacy)
    window.limpiarFiltros = function() {
        $('#zona-filtro select').val('');
        $('#zona-filtro input').val('');
    };
    
    // Funci√≥n para aplicar filtros personalizados
    window.aplicarFiltrosSolic = function() {
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        
        // Obtener valores de filtros
        const filtroInstalacion = $('#filtroInstalacionGMSolic').val();
        const filtroEquipos = $('#filtroEquiposSolic').val().toLowerCase();
        const filtroTipoInterv = $('#filtroTipoIntervencionSolic').val();
        const filtroRiesgo = $('#filtroRiesgoSolic').val();
        const filtroSODI = $('#filtroAplicaSODISolic').val();
        const filtroFechaDesde = $('#filtroFechaDesdeSolic').val();
        const filtroFechaHasta = $('#filtroFechaHastaSolic').val();
        
        // Aplicar b√∫squeda por Instalaci√≥n GM (columna 4)
        table.column(4).search(filtroInstalacion);
        
        // Aplicar b√∫squeda por Equipos (columna 5)
        table.column(5).search(filtroEquipos);
        
        // Aplicar b√∫squeda por Tipo Intervenci√≥n (columna 6)
        table.column(6).search(filtroTipoInterv);
        
        // Aplicar b√∫squeda por Riesgo (columna 7)
        table.column(7).search(filtroRiesgo);
        
        // Aplicar b√∫squeda por Aplica SODI (columna 8)
        table.column(8).search(filtroSODI);
        
        // Redibujar tabla
        table.draw();
        
        console.log('Filtros aplicados:', {filtroInstalacion, filtroEquipos, filtroTipoInterv, filtroRiesgo, filtroSODI});
    };
    
    // Funci√≥n para limpiar filtros personalizados
    window.limpiarFiltrosSolic = function() {
        // Limpiar inputs
        $('#filtroInstalacionGMSolic').val('');
        $('#filtroEquiposSolic').val('');
        $('#filtroTipoIntervencionSolic').val('');
        $('#filtroRiesgoSolic').val('');
        $('#filtroAplicaSODISolic').val('');
        $('#filtroFechaDesdeSolic').val('');
        $('#filtroFechaHastaSolic').val('');
        
        // Limpiar b√∫squedas de DataTable
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        table.search('').columns().search('').draw();
        
        console.log('Filtros limpiados');
    };
    
    // Funci√≥n para filtrar por estado
    window.filtrarPorEstado = function(tipo) {
        console.log('Filtrando por:', tipo);
        filtroActual = tipo;
        
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        
        // Aplicar el filtro y redibujar
        table.draw();
    };
    
    // Destruir DataTable si ya existe
    if ($.fn.DataTable.isDataTable('#tablaSolicitudesSolicitante')) {
        $('#tablaSolicitudesSolicitante').DataTable().destroy();
    }
    
    // Limpiar filtros personalizados anteriores
    $.fn.dataTable.ext.search = [];
    
    // Remover el display:none inline de las filas finalizadas para que DataTables las pueda procesar
    $('.solicitud-finalizada').removeAttr('style');
    
    // Estados que se consideran "En Proceso" para Solicitante
    const estadosEnProceso = ['Pendiente', 'Devuelta', 'En An√°lisis', 'Administrador Gestionando', 'Programada'];
    
    // Estados que se consideran "Finalizadas"
    const estadosFinalizadas = ['Finalizada', 'No Solicitada', 'Rechazada', 'Suspendida'];
    
    // Funci√≥n de filtro personalizada
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // data[9] es la columna del Estado (√≠ndice 9, la √∫ltima columna)
            const estadoColumna = data[9]; // Contiene el HTML del badge
            
            // Extraer el texto del estado del HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = estadoColumna;
            const estado = tempDiv.textContent.trim();
            
            if (filtroActual === 'proceso') {
                // Mostrar solo estados en proceso
                return estadosEnProceso.includes(estado);
            } else if (filtroActual === 'finalizadas') {
                // Mostrar solo estados finalizadas
                return estadosFinalizadas.includes(estado);
            }
            return true;
        }
    );
    
    $('#tablaSolicitudesSolicitante').DataTable({
        "language": {
            "lengthMenu": "Mostrando _MENU_ solicitudes por p√°gina",
            "zeroRecords": "No se encontraron resultados",
            "info": "Total solicitudes: _TOTAL_. Mostrando p√°gina _PAGE_ de _PAGES_",
            "infoEmpty": "No hay solicitudes disponibles",
            "infoFiltered": "(filtrado de _MAX_ solicitudes totales)",
            "search": "Buscar",
            "paginate": {
                "first": "Primero",
                "last": "√öltimo",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Mostrar todo"]],
        "responsive": true,
        "order": [[1, "desc"]],
        "columnDefs": [
            { "orderable": false, "targets": 0 }
        ]
    });
})();
</script>

<!-- Cargar modales del solicitante -->
<script src="modals/solicitante/modals-loader.js?v=4" defer></script>
